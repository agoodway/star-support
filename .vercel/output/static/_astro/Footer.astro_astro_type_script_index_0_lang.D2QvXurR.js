const i={chat:`<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    <circle cx="9" cy="9" r="1" fill="currentColor"/>
    <circle cx="15" cy="9" r="1" fill="currentColor"/>
  </svg>`,robot:`<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <g transform="translate(12, 9) scale(0.75) translate(-12, -12)">
      <path d="M12 6V2H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <rect width="16" height="12" x="4" y="8" rx="2" stroke="currentColor" stroke-width="2"/>
      <path d="M2 14h2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M20 14h2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M15 13v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M9 13v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </g>
    <path fill="currentColor" transform="translate(12, 20) scale(0.15) translate(-40, -85)" d="M25.8 85.2c-4.5-4.2-5.9-12.8-4-19.1 3.3 4 7.8 5.2 12.5 6 7.2 1 14.3.6 21-2.7l2.4-1.4c.6 1.8.8 3.7.5 5.6-.5 4.5-2.8 8-6.4 10.7-1.4 1.1-3 2-4.5 3-4.6 3.2-5.8 6.8-4 12.1v.6a12 12 0 0 1-5.3-4.6 13 13 0 0 1-2-7c0-1.2 0-2.5-.2-3.7-.4-3-1.8-4.3-4.5-4.4a5.2 5.2 0 0 0-5.4 4.2l-.1.7Z"/>
  </svg>`,robotWhite:`<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
    <g transform="translate(16, 13) scale(1.0) translate(-12, -12)">
      <path d="M12 6V2H8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <rect width="16" height="12" x="4" y="8" rx="2" stroke="white" stroke-width="2"/>
      <path d="M2 14h2" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M20 14h2" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M15 13v2" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M9 13v2" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </g>
    <path fill="white" transform="translate(16, 28) scale(0.2) translate(-40, -85)" d="M25.8 85.2c-4.5-4.2-5.9-12.8-4-19.1 3.3 4 7.8 5.2 12.5 6 7.2 1 14.3.6 21-2.7l2.4-1.4c.6 1.8.8 3.7.5 5.6-.5 4.5-2.8 8-6.4 10.7-1.4 1.1-3 2-4.5 3-4.6 3.2-5.8 6.8-4 12.1v.6a12 12 0 0 1-5.3-4.6 13 13 0 0 1-2-7c0-1.2 0-2.5-.2-3.7-.4-3-1.8-4.3-4.5-4.4a5.2 5.2 0 0 0-5.4 4.2l-.1.7Z"/>
  </svg>`,robotAstro:`<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <g transform="translate(12, 5) scale(0.95) translate(-12, -12)">
      <path d="M12 8V4H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <rect width="16" height="12" x="4" y="8" rx="2" stroke="currentColor" stroke-width="2"/>
      <path d="M2 14h2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M20 14h2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M15 13v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M9 13v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </g>
    <path fill="currentColor" transform="translate(12, 21) scale(0.25) translate(-40, -85)" d="M25.8 85.2c-4.5-4.2-5.9-12.8-4-19.1 3.3 4 7.8 5.2 12.5 6 7.2 1 14.3.6 21-2.7l2.4-1.4c.6 1.8.8 3.7.5 5.6-.5 4.5-2.8 8-6.4 10.7-1.4 1.1-3 2-4.5 3-4.6 3.2-5.8 6.8-4 12.1v.6a12 12 0 0 1-5.3-4.6 13 13 0 0 1-2-7c0-1.2 0-2.5-.2-3.7-.4-3-1.8-4.3-4.5-4.4a5.2 5.2 0 0 0-5.4 4.2l-.1.7Z"/>
  </svg>`,close:`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <line x1="18" y1="6" x2="6" y2="18"/>
    <line x1="6" y1="6" x2="18" y2="18"/>
  </svg>`,send:`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <line x1="22" y1="2" x2="11" y2="13"/>
    <polygon points="22,2 15,22 11,13 2,9"/>
  </svg>`},u={api:{baseUrl:"",endpoints:{chat:"/api/star-support/chat",config:"/api/star-support/config",feedback:"/api/star-support/feedback"}},ui:{position:"bottom-right",theme:"light",colors:{primary:"#6366f1",secondary:"#8b5cf6",background:"#ffffff",text:"#1e293b"}},behavior:{welcomeMessage:"Hi! How can I help you today?",placeholderText:"Type your message...",botName:"AI Bot"}};class g{constructor(t={}){this.container=null,this.button=null,this.chat=null,this.messagesContainer=null,this.input=null,this.config={...u,...t},this.state={isOpen:!1,messages:[],isLoading:!1},this.init()}init(){try{this.createButton(),this.createChat(),this.setupTheme(),this.addMockMessages()}catch(t){console.error("Star Support: Failed to initialize widget",t),this.showErrorState("Failed to initialize chat widget. Please refresh the page.")}}showErrorState(t){const s=document.createElement("button");s.className="star-support-button star-support-widget star-support-error",s.innerHTML="⚠️",s.setAttribute("aria-label",t),s.title=t,s.addEventListener("click",()=>{s.remove(),this.init()}),document.body.appendChild(s)}createButton(){this.button=document.createElement("button"),this.button.className="star-support-button star-support-widget";const t=this.config.ui?.buttonIcon||"robotWhite";this.button.innerHTML=i[t]||i.robotWhite,this.button.setAttribute("aria-label","Open chat support"),this.button.addEventListener("click",()=>this.toggleChat()),document.body.appendChild(this.button)}createChat(){this.chat=document.createElement("div"),this.chat.className="star-support-chat star-support-widget star-support-hidden",this.chat.setAttribute("data-position",this.config.ui?.position||"bottom-right"),this.chat.innerHTML=`
      <div class="star-support-header">
        <h3 class="star-support-title">${this.config.behavior?.headerTitle||"Support Chat"}</h3>
        <button class="star-support-close" aria-label="Close chat">${i.close}</button>
      </div>
      <div class="star-support-messages"></div>
      <div class="star-support-input-container">
        <input 
          type="text" 
          class="star-support-input" 
          placeholder="${this.config.behavior?.placeholderText||"Type your message..."}"
          maxlength="1000"
        />
        <button class="star-support-send" aria-label="Send message">${i.send}</button>
      </div>
    `,this.messagesContainer=this.chat.querySelector(".star-support-messages"),this.input=this.chat.querySelector(".star-support-input");const t=this.chat.querySelector(".star-support-close"),s=this.chat.querySelector(".star-support-send");t?.addEventListener("click",()=>this.closeChat()),s?.addEventListener("click",()=>this.sendMessage()),this.input?.addEventListener("keypress",e=>{e.key==="Enter"&&this.sendMessage()}),document.body.appendChild(this.chat)}setupTheme(){const t=this.config.ui?.theme||"light";if(t==="auto"){const s=window.matchMedia("(prefers-color-scheme: dark)").matches;document.documentElement.setAttribute("data-theme",s?"dark":"light")}else document.documentElement.setAttribute("data-theme",t);if(this.config.ui?.colors){const{primary:s,secondary:e,background:o,text:r}=this.config.ui.colors,a=document.documentElement;s&&a.style.setProperty("--ss-primary",s),e&&a.style.setProperty("--ss-secondary",e),o&&a.style.setProperty("--ss-background",o),r&&a.style.setProperty("--ss-text",r)}}addMockMessages(){this.state.messages=[],this.renderMessages(),this.showWelcomeBubble()}showWelcomeBubble(){if(!this.messagesContainer)return;const t=document.createElement("div");t.className="star-support-welcome-bubble",t.innerHTML=`
      <div class="star-support-welcome-avatar">
        ${i.robot}
      </div>
      <div class="star-support-welcome-content">
        <div class="star-support-welcome-text">
          ${this.config.behavior?.welcomeMessage||"Hi! How can I help you with Astro today?"}
        </div>
      </div>
    `,this.messagesContainer.appendChild(t)}parseSimpleMarkdown(t){let s=t.replace(/```[\s\S]*?```/g,"");s=s.replace(/\[Code example:.*?\]/g,""),s=s.replace(/``[^`\n]+/g,"`");let e=s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");return e=e.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),e=e.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),e=e.replace(/__([^_]+)__/g,"<strong>$1</strong>"),e=e.replace(/(?<!\w)\*([^*]+)\*(?!\w)/g,"<em>$1</em>"),e=e.replace(/(?<!\w)_([^_]+)_(?!\w)/g,"<em>$1</em>"),e=e.replace(/`([^`\n]+)`/g,"<code>$1</code>"),e=e.replace(/\n\n/g,"<br><br>"),e=e.replace(/\n/g,"<br>"),e}renderMessages(){if(!this.messagesContainer)return;this.messagesContainer.scrollHeight;const t=this.messagesContainer.scrollTop+this.messagesContainer.clientHeight>=this.messagesContainer.scrollHeight-10;this.messagesContainer.innerHTML="";let s=null;this.state.messages.forEach((e,o)=>{const r=document.createElement("div");r.className=`star-support-message-wrapper ${e.role}`,e.role==="assistant"?r.innerHTML=`
          <div class="star-support-message-row">
            <div class="star-support-message-avatar">
              ${i.robot}
            </div>
            <div class="star-support-message-content">
              <div class="star-support-message ${e.role}">${this.parseSimpleMarkdown(e.content)}</div>
              ${e.sources&&e.sources.length>0?`
                <div class="star-support-sources">
                  <div class="star-support-sources-label">Sources:</div>
                  <div class="star-support-sources-list">
                    ${e.sources.map(a=>`
                      <a href="${a.url}" class="star-support-source-link" target="_blank" rel="noopener noreferrer">
                        <span class="star-support-source-icon">🔗</span>
                        <span class="star-support-source-title">${a.title}</span>
                        <span class="star-support-source-arrow">→</span>
                      </a>
                    `).join("")}
                  </div>
                </div>
              `:""}
              <div class="star-support-message-label">${this.config.behavior?.botName||"AI Bot"}</div>
            </div>
          </div>
        `:r.innerHTML=`
          <div class="star-support-message-content">
            <div class="star-support-message ${e.role}">${this.parseSimpleMarkdown(e.content)}</div>
            <div class="star-support-message-label">You</div>
          </div>
        `,e.role==="assistant"&&o===this.state.messages.length-1&&(s=r),this.messagesContainer.appendChild(r)}),s?s.scrollIntoView({behavior:"smooth",block:"start"}):t&&(this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight)}sanitizeInput(t){return t.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/javascript:/gi,"").replace(/on\w+\s*=/gi,"").replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi,"").replace(/<object\b[^<]*(?:(?!<\/object>)<[^<]*)*<\/object>/gi,"").replace(/<embed\b[^<]*>/gi,"").trim().substring(0,1e3)}async sendMessage(){if(!this.input||!this.input.value.trim()||this.state.isLoading)return;const t=this.input.value.trim(),s=this.sanitizeInput(t);this.input.value="";const e={id:Date.now().toString(),content:s,role:"user",timestamp:Date.now()};this.state.messages.push(e),this.renderMessages(),this.state.isLoading=!0,this.showLoading();try{const o=this.config.api.baseUrl||"",r=this.config.api.endpoints?.chat||"/api/star-support/chat/",a=o?`${o}${r}`:r,l=this.config.api.authKey||"",c={"Content-Type":"application/json"};l&&(c["x-auth-key"]=l);const h=await fetch(a,{method:"POST",headers:c,body:JSON.stringify({message:s})});if(!h.ok)throw new Error("Failed to get response");const d=await h.json(),p={id:(Date.now()+1).toString(),content:d.content||"Sorry, I could not process your request.",role:"assistant",timestamp:Date.now(),sources:d.sources};this.state.messages.push(p)}catch(o){console.error("Error sending message:",o);const r={id:(Date.now()+1).toString(),content:"Sorry, I encountered an error. Please try again.",role:"assistant",timestamp:Date.now()};this.state.messages.push(r)}finally{this.state.isLoading=!1,this.hideLoading(),this.renderMessages()}}showLoading(){if(!this.messagesContainer)return;const t=document.createElement("div");t.className="star-support-message-wrapper assistant",t.id="star-support-loading",t.innerHTML=`
      <div class="star-support-message-row">
        <div class="star-support-message-avatar">
          ${i.robot}
        </div>
        <div class="star-support-message-content">
          <div class="star-support-message assistant typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <div class="star-support-message-label">${this.config.behavior?.botName||"AI Bot"}</div>
        </div>
      </div>
    `,this.messagesContainer.appendChild(t),this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}hideLoading(){document.getElementById("star-support-loading")?.remove()}toggleChat(){this.state.isOpen?this.closeChat():this.openChat()}openChat(){this.state.isOpen=!0,this.button?.classList.add("star-support-hidden"),this.chat?.classList.remove("star-support-hidden"),this.input?.focus()}closeChat(){this.state.isOpen=!1,this.button?.classList.remove("star-support-hidden"),this.chat?.classList.add("star-support-hidden")}mount(t){const s=document.querySelector(t);s&&(s.appendChild(this.button),s.appendChild(this.chat))}destroy(){this.button?.remove(),this.chat?.remove()}}class m extends HTMLElement{constructor(){super(...arguments),this.widget=null}static get observedAttributes(){return["api-base-url","theme","position","welcome-message","bot-name","header-title","button-icon"]}connectedCallback(){try{const t={api:{baseUrl:this.getAttribute("api-base-url")||"",authKey:this.getAttribute("auth-key")||void 0},ui:{theme:this.getAttribute("theme")||"light",position:this.getAttribute("position")||"bottom-right",buttonIcon:this.getAttribute("button-icon")||void 0},behavior:{welcomeMessage:this.getAttribute("welcome-message")||void 0,botName:this.getAttribute("bot-name")||void 0,headerTitle:this.getAttribute("header-title")||void 0}};this.widget=new g(t)}catch(t){console.error("Star Support: Failed to initialize web component",t),this.dispatchEvent(new CustomEvent("star-support-error",{detail:{error:t,message:"Failed to initialize Star Support widget"},bubbles:!0,composed:!0}))}}disconnectedCallback(){this.widget?.destroy()}attributeChangedCallback(t,s,e){s!==e&&this.widget&&(this.widget.destroy(),this.connectedCallback())}}customElements.define("star-support",m);const b=document.querySelector("star-support");if(b){console.log("🚀 Star Support widget initialized");const n=document.createElement("style");n.textContent=`
      :root {
        --ss-primary: var(--sl-color-accent);
        --ss-secondary: var(--sl-color-text-accent);
        --ss-background: var(--sl-color-bg);
        --ss-surface: var(--sl-color-bg-sidebar);
        --ss-text: var(--sl-color-text);
        --ss-text-secondary: var(--sl-color-text-soft);
        --ss-border: var(--sl-color-hairline-shade);
        --ss-shadow: rgba(0, 0, 0, 0.1);
        --ss-radius: var(--sl-border-radius);
        --ss-font-family: var(--sl-font);
      }
      
      [data-theme="dark"] {
        --ss-shadow: rgba(0, 0, 0, 0.3);
      }
      
      /* Ensure widget is above Starlight elements */
      .star-support-widget {
        z-index: 9999;
      }
      .star-support-chat {
        z-index: 10000;
      }
    `,document.head.appendChild(n)}
